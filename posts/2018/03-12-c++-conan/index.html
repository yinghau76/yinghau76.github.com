<!doctype html>
<html prefix="og: http://ogp.me/ns#">
<head>
    <title>C&#43;&#43; 套件管理: 使用 Conan</title>

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta content="text/html; charset=UTF-8" http-equiv="Content-Type">

  <meta property="og:site_name" content="Simply Patrick"/>
  <meta property="og:url" content="https://blog.simplypatrick.com/posts/2018/03-12-c&#43;&#43;-conan/"/>
  <meta property="og:type" content="website"/>
  <meta property="og:image" content="https://lh3.googleusercontent.com/-GqbL2_hPq9Y/UC9brHyHa1I/AAAAAAAAEoY/rGGtCNWe3Vw/s800/patrick.jpg"/>

    <link href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/bootstrap-toc.css" rel="stylesheet">
  <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">

  <link href='//fonts.googleapis.com/css?family=Julee' rel='stylesheet' type='text/css'>
  <link href='//fonts.googleapis.com/css?family=Just+Me+Again+Down+Here' rel='stylesheet' type='text/css'>
  <link href='//fonts.googleapis.com/css?family=Source+Code+Pro' rel='stylesheet' type='text/css'>
  <link href='//fonts.googleapis.com/css?family=Arvo' rel='stylesheet' type='text/css'>

  <link href="/css/prism.css" rel="stylesheet" />
  <link href="/css/blog.css" rel="stylesheet" >

  <link href="/images/favicon.ico" rel="shortcut icon" type="image/x-icon" />


  <meta property="og:site_name" content="Simply Patrick"/>
  <meta property="og:url" content="https://blog.simplypatrick.com/posts/2018/03-12-c&#43;&#43;-conan/"/>
  <meta property="og:title" content="C&#43;&#43; 套件管理: 使用 Conan"/>
  <meta property="og:type" content="article"/>
  <meta property="og:article:published_time" content="2018-03-11 00:00:00 &#43;0000 UTC"/>
  
  <meta property="og:article:tag" content="c&#43;&#43;"/>
  
  <meta property="og:article:author" content="Patrick Tsai"/>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container" id="main">
    <div class="row">
      <header role="banner">
  <div class="row">
    <div class="col-md-9">
      <h1 class="banner-title">
        <a href="/">Simply Patrick</a>
        <small class="banner-subtitle">Hopes can always go up, tears can only come down.</small>
      </h1>
    </div>
    <div class="col-md-3 text-right">
      <ul class="social-links list-inline">
        <li><a href="https://twitter.com/PatrickSimply"><i class="fa fa-twitter"></i></a></li>
        <li><a href="https://www.facebook.com/yinghau76"><i class="fa fa-facebook"></i></a></li>
        <li><a href="https://www.linkedin.com/in/yinghau76"><i class="fa fa-linkedin"></i></a></li>
        <li><a href="https://github.com/p47t"><i class="fa fa-github-alt"></i></a></li>
      </ul>
    </div>
  <div>
</header>

      <nav class="navbar navbar-default" role="navigation">
  <div class="container-fluid">
    
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/posts/">posts</a>
      <a class="navbar-brand" href="/tils/">TILs</a>
    </div>

    
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">categories <b class="caret"></b></a>
          <ul class="dropdown-menu">
          
            <li><a href="/categories/blog">blog <span class="badge">3</span></a></li>
          
            <li><a href="/categories/business">business <span class="badge">26</span></a></li>
          
            <li><a href="/categories/career">career <span class="badge">20</span></a></li>
          
            <li><a href="/categories/development">development <span class="badge">52</span></a></li>
          
            <li><a href="/categories/game">game <span class="badge">3</span></a></li>
          
            <li><a href="/categories/programming">programming <span class="badge">184</span></a></li>
          
            <li><a href="/categories/web">web <span class="badge">10</span></a></li>
          
          </ul>
        </li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">tags <b class="caret"></b></a>
          <ul class="dropdown-menu">
          
            <li><a href="/tags/agile">agile <span class="badge">4</span></a></li>
          
            <li><a href="/tags/android">android <span class="badge">12</span></a></li>
          
            <li><a href="/tags/book">book <span class="badge">25</span></a></li>
          
            <li><a href="/tags/build">build <span class="badge">3</span></a></li>
          
            <li><a href="/tags/c&#43;&#43;">c&#43;&#43; <span class="badge">3</span></a></li>
          
            <li><a href="/tags/cloud">cloud <span class="badge">1</span></a></li>
          
            <li><a href="/tags/crack">crack <span class="badge">2</span></a></li>
          
            <li><a href="/tags/cxx">cxx <span class="badge">5</span></a></li>
          
            <li><a href="/tags/dotnet">dotnet <span class="badge">42</span></a></li>
          
            <li><a href="/tags/embedded">embedded <span class="badge">5</span></a></li>
          
            <li><a href="/tags/engineer">engineer <span class="badge">2</span></a></li>
          
            <li><a href="/tags/font">font <span class="badge">3</span></a></li>
          
            <li><a href="/tags/fuchsia">fuchsia <span class="badge">2</span></a></li>
          
            <li><a href="/tags/game">game <span class="badge">2</span></a></li>
          
            <li><a href="/tags/git">git <span class="badge">4</span></a></li>
          
            <li><a href="/tags/go">go <span class="badge">5</span></a></li>
          
            <li><a href="/tags/google">google <span class="badge">5</span></a></li>
          
            <li><a href="/tags/ios">ios <span class="badge">5</span></a></li>
          
            <li><a href="/tags/java">java <span class="badge">9</span></a></li>
          
            <li><a href="/tags/jupyter">jupyter <span class="badge">1</span></a></li>
          
            <li><a href="/tags/kotlin">kotlin <span class="badge">2</span></a></li>
          
            <li><a href="/tags/kuso">kuso <span class="badge">3</span></a></li>
          
            <li><a href="/tags/management">management <span class="badge">3</span></a></li>
          
            <li><a href="/tags/microsoft">microsoft <span class="badge">14</span></a></li>
          
            <li><a href="/tags/octopress">octopress <span class="badge">3</span></a></li>
          
            <li><a href="/tags/osx">osx <span class="badge">4</span></a></li>
          
            <li><a href="/tags/patterns">patterns <span class="badge">4</span></a></li>
          
            <li><a href="/tags/process">process <span class="badge">2</span></a></li>
          
            <li><a href="/tags/ruby">ruby <span class="badge">15</span></a></li>
          
            <li><a href="/tags/rust">rust <span class="badge">3</span></a></li>
          
            <li><a href="/tags/scala">scala <span class="badge">3</span></a></li>
          
            <li><a href="/tags/startup">startup <span class="badge">3</span></a></li>
          
            <li><a href="/tags/web">web <span class="badge">2</span></a></li>
          
            <li><a href="/tags/webkit">webkit <span class="badge">3</span></a></li>
          
            <li><a href="/tags/windows">windows <span class="badge">5</span></a></li>
          
            <li><a href="/tags/work">work <span class="badge">11</span></a></li>
          
          </ul>
        </li>
      </ul>
      <form class="navbar-form navbar-left" role="search" action="//google.com/search" method="get">
        <div class="form-group">
          <input type="hidden" name="as_sitesearch" value="blog.simplypatrick.com" />
          <input class="form-control" type="text" name="q" results="0" placeholder="search"/>
        </div>
        <button type="submit" class="btn btn-default">submit</button>
      </form>
      <ul class="nav navbar-nav navbar-right">
        <li><a href="/pages/about">about</a></li>
      </ul>
    </div>
  </div>
</nav>

    </div>

  <div class="row">
    <div class="col-md-9">
          <div class="row">
      <div class="col-xs-6">
        
        <section id="prev" class="text-left">
          <a class="previous" href="https://blog.simplypatrick.com/posts/2018/03-10-catch2/">
            <span class="glyphicon glyphicon-circle-arrow-left"></span>
            C&#43;&#43; 單元測試: 使用 Catch2
          </a>
        </section>
        
      </div>
      <div class="col-xs-6">
        
        <section id="next" class="text-right">

          <a class="next" href="https://blog.simplypatrick.com/posts/2019/04-08-learning-rust/">
            Learning Rust
            <span class="glyphicon glyphicon-circle-arrow-right"></span>
          </a>
        </section>
        
      </div>
    </div>
      <h2 class="post-title">C&#43;&#43; 套件管理: 使用 Conan</h2>
      <div class="post-meta">
        <span class="post-date">March 11, 2018</span>
        
        <a href="/categories/programming"><span class="label label-info">programming</span></a>
        
        
        <a href="/tags/c&#43;&#43;"><span class="label label-primary">c&#43;&#43;</span></a>
        
      </div>
      
<div>
  
  <hr/>
  <p>
    <a href="" id="series"></a>
    這篇文章屬於 <b>Modern C&#43;&#43;</b> 系列:
  </p>

  
  
  <ul class="series">
  
    <li>Mar 11, 2018 - <a href="https://blog.simplypatrick.com/posts/2018/03-12-c&#43;&#43;-conan/">C&#43;&#43; 套件管理: 使用 Conan</a></li>
  
    <li>Mar 10, 2018 - <a href="https://blog.simplypatrick.com/posts/2018/03-10-catch2/">C&#43;&#43; 單元測試: 使用 Catch2</a></li>
  
  </ul>
</div>


      <div class="post-content">
        <h3 id="手動管理-cc-套件">手動管理 C/C++ 套件</h3>
<p>想像你需要使用 <a href="https://llvm.org/">LLVM</a> 開發一個程式，如果在 macOS 上，最簡單的安裝方法是用 Homebrew，一行就搞定: <code>brew install llvm</code>。但 Homebrew 上的版本不一定是最新的而且也無法同時安裝不同的版本 (例如 LLVM 5.0/6.0 共存) 或同版本但不同設置（例如 LLVM 6.0 的 debug/release 版本)；而在 Linux 及 Windows 上也有各自不同的安裝問題。</p>
<p>安裝完畢後，麻煩才剛開始：通常第一步是設置編譯環境的 CPPFLAGS 及 LDFLAGS:</p>
<pre><code>For compilers to find this software you may need to set:
    LDFLAGS:  -L/usr/local/opt/llvm/lib
    CPPFLAGS: -I/usr/local/opt/llvm/include
</code></pre><p>根據不同的開發環境或編譯器，設置的方法也都不同。最後設置完後編譯及連結也不一定能成功，因為 LLVM 本身可能又依賴其他套件，還需要把它的 dependencies 一一安裝及設置。</p>
<h3 id="conan-介紹">Conan 介紹</h3>
<p>Conan 企圖幫助 C/C++ 脫離這個窘境：沒有一個像樣的套件管理 (package management) 工具。</p>
<p>我建議先讀一下 Conan 的文檔來了解如何<a href="http://docs.conan.io/en/latest/installation.html">安裝 Conan</a> 以及<a href="http://docs.conan.io/en/latest/getting_started.html">利用 Conan 來使用現成的程式庫</a>。</p>
<p>如果你是使用 CMake，事情會簡單一些，因為 Conan 提供的 CMake 整合還算好用，使用範例可以參考這個基於 LLVM 的小程式: <a href="https://github.com/p47r1ck7541/clike">clike</a>。</p>
<h3 id="下載套件">下載套件</h3>
<p>除了預設的 <code>conan-center</code>，Conan 官網建議也可以到 <a href="https://bintray.com/bincrafters/public-conan"><code>bincrafters</code></a> 及 <a href="https://bintray.com/conan-community/conan"><code>conan-community</code></a> 裡尋找，可以用下列指令新增這兩個 remote:</p>
<pre class="command-line" data-user="pat" data-host="host"><code class="language-bash">$ <span class="token function">conan</span> remote add conan-community https://api.bintray.com/conan/conan-community/conan
$ <span class="token function">conan</span> remote add bincrafters https://api.bintray.com/conan/bincrafters/public-conan</code></pre>
<p>之後就可以指定 remote 搜尋 package:</p>
<pre class="command-line" data-user="pat" data-host="host" data-output="2-4"><code class="language-bash">$ <span class="token function">conan</span> search ffmpeg -r=bincrafters
Existing package recipes:

ffmpeg/3.4@bincrafters/stable</code></pre>
<p>目前 server 上面的套件數量不算多，有可能你會找不到你想要的，因此你不能期待很快地有人會幫你做出來，相反地你<strong>必須學會自己創建套件</strong>才能充分得到使用 Conan 的好處。</p>
<h3 id="創建-package">創建 package</h3>
<p>自己創建一個套件其實也不難，基本的概念如下:</p>
<img src='/posts/2018/03-12-c&#43;&#43;-conan/package_create_flow.png' width="100%">
<p>整個建置過程需要的目錄結構及流程會是由 Conan 來控制，但你需要提供一個 <a href="http://docs.conan.io/en/latest/reference/conanfile/methods.html">conanfile.py</a> 描述每個步驟裡的需要執行的動作。Conan 會把打包的套件放在一個 local cache 裡讓其他的程式來使用。</p>
<p>以下示範如何下載 LLVM 6.0 的原始碼, 編譯，最後把它包裝成套件：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> conans <span style="color:#f92672">import</span> ConanFile, CMake
<span style="color:#f92672">import</span> glob
<span style="color:#f92672">import</span> os

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">LlvmConan</span>(ConanFile):
    name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;LLVM&#34;</span>
    version <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;release_60&#34;</span>
    license <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;LLVM Release License&#34;</span>
    url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://github.com/p47r1ck7541/llvm-60&#34;</span>
    description <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (name, version)
    settings <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;os&#34;</span>, <span style="color:#e6db74">&#34;compiler&#34;</span>, <span style="color:#e6db74">&#34;build_type&#34;</span>, <span style="color:#e6db74">&#34;arch&#34;</span>
    generators <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;cmake&#34;</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">source</span>(self):
        self<span style="color:#f92672">.</span>run(<span style="color:#e6db74">&#34;git clone https://github.com/llvm-mirror/llvm -b </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> --depth 1 src&#34;</span> <span style="color:#f92672">%</span> self<span style="color:#f92672">.</span>version)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">build</span>(self):
        cmake <span style="color:#f92672">=</span> CMake(self)
        cmake<span style="color:#f92672">.</span>configure(source_folder<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;src&#34;</span>)
        cmake<span style="color:#f92672">.</span>install()

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">package</span>(self):
        <span style="color:#75715e"># nothing to do here now because we reuse &#39;cmake install&#39; to package files</span>
        <span style="color:#66d9ef">pass</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">package_info</span>(self):
        self<span style="color:#f92672">.</span>cpp\_info<span style="color:#f92672">.</span>libs <span style="color:#f92672">=</span> \[os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>basename(a) <span style="color:#66d9ef">for</span> a <span style="color:#f92672">in</span> glob<span style="color:#f92672">.</span>glob(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(self<span style="color:#f92672">.</span>package\_folder, <span style="color:#e6db74">&#34;lib&#34;</span>, <span style="color:#e6db74">&#34;*.a&#34;</span>))\]
        self<span style="color:#f92672">.</span>cpp_info<span style="color:#f92672">.</span>cppflags <span style="color:#f92672">=</span> \[<span style="color:#e6db74">&#34;-std=c++11&#34;</span>, <span style="color:#e6db74">&#34;-fno-rtti&#34;</span>\]
        self<span style="color:#f92672">.</span>cpp_info<span style="color:#f92672">.</span>exelinkflags <span style="color:#f92672">=</span> \[<span style="color:#e6db74">&#34;-lcurses&#34;</span>, <span style="color:#e6db74">&#34;-lz&#34;</span>\]
</code></pre></div><p>幾個關鍵步驟：</p>
<ol>
<li><a href="http://docs.conan.io/en/latest/reference/conanfile/methods.html#source"><code>source()</code></a>: 利用 <code>git clone</code> 下載原始碼</li>
<li><a href="http://docs.conan.io/en/latest/reference/conanfile/methods.html#build"><code>build()</code></a>: 負責編譯，這裏我們直接使用 Conan 提供的 CMake class 來控制 cmake 的執行，值得注意的是我們直接利用 <code>cmake.install()</code> 來取代實際打包套件的工作。</li>
<li><a href="http://docs.conan.io/en/latest/reference/conanfile/methods.html#package"><code>package()</code></a>: 如上解釋，不需做任何事。</li>
<li><a href="http://docs.conan.io/en/latest/reference/conanfile/methods.html#package-info"><code>package_info()</code></a>: 提供套件的相關使用資訊。例如 <code>cppflags</code> 及 <code>exelinkflags</code> 是寫死的，但 <code>libs</code> 則是運行 Python script 搜尋編譯結果找出來的。</li>
</ol>
<p>完整範例可以參考這個 GitHub project: <a href="https://github.com/p47r1ck7541/conan-llvm-60">conan-llvm-60</a>。</p>
<p>實際運作過程如下(中間請自行快轉):</p>
<script src="https://asciinema.org/a/9yi010lhV4Bvjk321P8h151aB.js" id="asciicast-9yi010lhV4Bvjk321P8h151aB" async></script>
<h3 id="總結">總結</h3>
<p>就簡化自己手動管理 C/C++ 套件的工作來看，我認為 Conan 提供的好處值得你花時間去學它，至於它是否能成為主流的 C/C++ 套件管理工具，那就等待時間來驗證了。</p>

      </div>

      <hr>
      <div id="disqus_thread"></div>
<script>




(function() { 
var d = document, s = d.createElement('script');

s.src = '//simplypatrick.disqus.com/embed.js';

s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

    </div>
    <div class="col-md-3">
      <aside class="toc">
        






<nav id="toc" data-toggle="toc">
  
  <ul class="nav">
  </ul>
</nav>

      </aside>
    </div>
  </div>
    </div>

    <div class="row">
    <div class="col-md-12">
      <footer id="footer" class="text-center">
        © Patrick Tsai 2003-2019.
        Proudly powered by <a href="http://gohugo.io/">Hugo</a>.
      </footer>
    </div>
  </div>

  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
  <script src="/js/bootstrap-toc.min.js"></script>
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-73968064-1', 'auto');
  ga('send', 'pageview');

</script>


  <script src="/js/prism.js"></script>

</body>
</html>
